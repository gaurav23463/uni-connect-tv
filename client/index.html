<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>UniConnect TV â€” Classic UI (MVP)</title>
<style>
  /* Simple classic UI (no 3D). Restore your previous look */
  :root{
    --bg:#0b0c10; --panel:#0f1720; --muted:#9aa4b2; --text:#e6eef8;
    --accent:#5b8cff; --danger:#ff6b6b; --success:#4ade80; --radius:12px;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#07101a,#0b0c10);color:var(--text);-webkit-font-smoothing:antialiased}
  .container{max-width:1100px;margin:22px auto;padding:16px}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:56px;height:56px;border-radius:10px;background:var(--accent);display:grid;place-items:center;font-weight:800;color:#fff}
  .title{font-size:18px;font-weight:700}
  .subtitle{font-size:13px;color:var(--muted)}
  .controls{display:flex;gap:10px;align-items:center}
  .btn{padding:10px 12px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);color:var(--text);cursor:pointer;font-weight:700}
  .btn.primary{background:var(--accent);color:#fff;border:none;box-shadow:0 8px 24px rgba(91,140,255,0.12)}
  .layout{display:grid;grid-template-columns: 1fr 360px;gap:20px}
  @media (max-width:1000px){ .layout{grid-template-columns:1fr} }
  .panel{background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent); padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
  .video-area{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  @media (max-width:900px){ .video-area{grid-template-columns:1fr} }
  .video-box{min-height:320px;border-radius:8px;background:#0b1117;border:1px solid rgba(255,255,255,0.03);display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden}
  .video-box .label{position:absolute;left:10px;top:8px;background:rgba(0,0,0,0.45);padding:6px 8px;border-radius:8px;font-weight:700;color:var(--text)}
  .video-box .status{position:absolute;right:10px;top:10px;width:12px;height:12px;border-radius:50%;background:rgba(255,255,255,0.06)}
  .video-placeholder{color:var(--muted);font-weight:700}
  video{width:100%;height:100%;object-fit:cover}
  .chat {display:flex;flex-direction:column;gap:10px}
  #chatMessages{height:340px;overflow:auto;padding:8px;display:flex;flex-direction:column;gap:8px}
  .message{padding:8px 10px;border-radius:10px;max-width:80%;font-size:14px}
  .message.own{align-self:flex-end;background:linear-gradient(90deg,#071426,#061021);border:1px solid rgba(255,255,255,0.02)}
  .message.other{align-self:flex-start;background:rgba(255,255,255,0.03)}
  .chat-input{display:flex;gap:8px}
  .chat-input textarea{flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--text);resize:none}
  .small{font-size:13px;color:var(--muted)}
  .notification{position:fixed;top:18px;right:18px;background:#07111a;padding:10px 14px;border-radius:10px;color:var(--text);box-shadow:0 8px 30px rgba(0,0,0,0.6);border-left:4px solid var(--accent);z-index:9999}
  /* modal simple */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:9998}
  .modal {width:360px;background:#0c1116;padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
  footer{text-align:center;color:var(--muted);margin-top:16px;font-size:13px}
</style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo">UC</div>
        <div>
          <div class="title">UniConnect TV</div>
          <div class="subtitle">Classic interface â€” stable MVP</div>
        </div>
      </div>
      <div class="controls">
        <button class="btn" onclick="openAuthModal()">Account</button>
        <button class="btn" onclick="startDemo()">Demo</button>
        <button class="btn primary" onclick="startChatFromLanding()">Start Chat</button>
      </div>
    </header>

    <!-- Main layout -->
    <div class="layout">
      <!-- left: video area -->
      <div>
        <div class="video-area panel" id="videoArea">
          <div class="video-box" id="localBox">
            <div class="label">You</div>
            <div id="localStatus" class="status" title="local status"></div>
            <div class="video-placeholder">Camera not active</div>
          </div>

          <div class="video-box" id="remoteBox">
            <div class="label">Partner</div>
            <div id="remoteStatus" class="status" title="remote status"></div>
            <div class="video-placeholder">Not connected</div>
          </div>
        </div>

        <div style="display:flex;gap:8px;margin-top:12px">
          <button class="btn" onclick="nextPartner()">Next</button>
          <button class="btn" onclick="endChat()">End</button>
          <button class="btn" onclick="reportUser()">Report</button>
          <div style="flex:1"></div>
          <button class="btn" id="muteBtn" onclick="toggleAudio()">Mute</button>
          <button class="btn" id="camBtn" onclick="toggleCamera()">Camera</button>
        </div>
      </div>

      <!-- right: chat panel -->
      <aside class="panel chat">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">Chat</div>
          <div class="small" id="signedEmail">Signed in: Anonymous</div>
        </div>

        <div id="chatMessages" aria-live="polite"></div>

        <div class="chat-input">
          <textarea id="chatInput" rows="2" placeholder="Type message and press Enter..." onkeydown="handleChatInput(event)"></textarea>
          <button class="btn primary" onclick="sendChatFromUI()">Send</button>
        </div>

        <div class="small">Tip: Use demo to try. Next to find a new partner.</div>
      </aside>
    </div>

    <footer>Â© UniConnect TV â€” Gaurav Tripathi</footer>
  </div>

  <!-- Auth Modal (simple) -->
  <div id="authModalBackdrop" style="display:none" class="modal-backdrop">
    <div class="modal">
      <h3 style="margin:0 0 10px 0">Login / Register</h3>
      <input id="email" placeholder="Email (optional)" style="width:100%;padding:10px;border-radius:8px;margin-bottom:8px;background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--text)" />
      <input id="password" placeholder="Password (optional)" type="password" style="width:100%;padding:10px;border-radius:8px;margin-bottom:8px;background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--text)" />
      <input id="department" placeholder="Department (optional)" style="width:100%;padding:10px;border-radius:8px;margin-bottom:12px;background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--text)" />
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button class="btn" onclick="closeAuthModal()">Cancel</button>
        <button class="btn primary" onclick="handleAuth(event)">Login</button>
      </div>
    </div>
  </div>

  <!-- socket.io -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

  <!-- Main JS: stable socket + webrtc + ui -->
  <script>
  (function(){
    // ====== CONFIG ======
    const API_BASE = window.location.hostname.includes('localhost') ? 'http://localhost:5000' : 'https://uni-connect-tv-5.onrender.com';
    // change above if your backend URL differs

    // ====== STATE ======
    let socket = null;
    let peerConnection = null;
    let partnerId = null;
    let localStream = null;
    let isMuted = false;
    let cameraOff = false;

    // simple notification dedupe
    let __lastNotif = {txt:'', t:0};
    function notify(txt){
      const now = Date.now();
      if (txt === __lastNotif.txt && now - __lastNotif.t < 2200) return;
      __lastNotif = { txt, t: now };
      const el = document.createElement('div'); el.className = 'notification'; el.textContent = txt;
      document.body.appendChild(el); setTimeout(()=> el.remove(), 3000);
    }

    // ====== UI Helpers ======
    function setSignedEmail(email){ document.getElementById('signedEmail').textContent = 'Signed in: ' + (email || 'Anonymous'); }
    window.openAuthModal = function(){ document.getElementById('authModalBackdrop').style.display = 'flex'; }
    window.closeAuthModal = function(){ document.getElementById('authModalBackdrop').style.display = 'none'; }
    window.startDemo = function(){
      // Demo: local-only, fake partner messages
      prepareLocalStreamIfNeeded().then(()=>{
        notify('Demo mode active');
        document.getElementById('chatMessages').innerHTML = '';
        addMessage('System','Demo partner connected (simulated).', false);
        setTimeout(()=> addMessage('Partner','Hey! This is a demo partner ðŸ˜Š', false), 700);
      });
    };

    // ====== SOCKET init (guarded) ======
    async function initSocket(){
      if (socket) return socket;
      socket = io(API_BASE, { transports:['websocket'] });

      // guard repeated initializations (hot reload / repeated calls)
      if (window.__uc_socket_inited) socket.removeAllListeners();
      else window.__uc_socket_inited = true;

      wireSocket();
      return socket;
    }

    function wireSocket(){
      socket.removeAllListeners();

      socket.on('connect', ()=> console.log('socket connected', socket.id));
      socket.on('waiting', ()=> notify('Waiting for a partner...'));
      socket.on('partner-found', async (id) => {
        partnerId = id;
        notify('Partner found â€” connecting...');
        // clear chat for fresh conversation
        const cm = document.getElementById('chatMessages'); if (cm) cm.innerHTML = '';
        await handleOutgoingOffer();
      });

      socket.on('signal', async ({ from, data }) => {
        partnerId = from;
        try {
          if (data.type === 'offer') {
            await handleIncomingOffer(data.offer, from);
          } else if (data.type === 'answer') {
            if (peerConnection && (peerConnection.signalingState === 'have-local-offer' || peerConnection.signalingState === 'stable')) {
              await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
            } else {
              console.warn('Ignoring answer due to signalingState', peerConnection ? peerConnection.signalingState : 'no-pc');
            }
          } else if (data.type === 'candidate') {
            if (peerConnection) await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
          }
        } catch(e){ console.error('signal handling error', e); }
      });

      socket.on('partner-left', ()=> {
        notify('Partner disconnected');
        cleanupPeer();
        resetRemotePlaceholder();
      });

      socket.on('chatMessage', (payload)=> {
        const text = normalizePayload(payload);
        addMessage('Partner', text, false);
      });
    }

    function normalizePayload(p){
      if (!p) return '';
      if (typeof p === 'string') {
        try { const j = JSON.parse(p); return j.text || j.msg || p; } catch { return p; }
      }
      if (p.text) return p.text;
      if (p.msg) return (typeof p.msg === 'string') ? p.msg : p.msg.text || JSON.stringify(p.msg);
      return JSON.stringify(p);
    }

    // ====== TURN / ICE ======
    async function getIceServers(){
      try {
        const r = await fetch(API_BASE + '/api/turn');
        if (!r.ok) throw new Error('no turn');
        const j = await r.json();
        return j.iceServers || [{ urls:'stun:stun.l.google.com:19302' }];
      } catch(e){
        console.warn('TURN fetch failed, falling back to STUN', e);
        return [{ urls:'stun:stun.l.google.com:19302' }];
      }
    }

    // ====== Local media & PeerConnection ======
    async function prepareLocalStreamIfNeeded(){
      if (localStream) return;
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ video:{width:{ideal:640},height:{ideal:480}}, audio:true });
        const localBox = document.getElementById('localBox');
        if (localBox) { localBox.innerHTML = ''; const v = document.createElement('video'); v.autoplay=true; v.muted=true; v.playsInline=true; v.srcObject = localStream; localBox.appendChild(v); document.getElementById('localStatus').style.background = 'linear-gradient(90deg,var(--accent),#b86bff)'; }
      } catch(e){
        console.error('getUserMedia error', e);
        notify('Camera/microphone access denied');
      }
    }

    async function createPeer(){
      const iceServers = await getIceServers();
      const config = { iceServers, iceCandidatePoolSize:10 };
      peerConnection = new RTCPeerConnection(config);

      if (!localStream) await prepareLocalStreamIfNeeded();
      localStream.getTracks().forEach(t => peerConnection.addTrack(t, localStream));

      peerConnection.ontrack = (e) => {
        const remoteBox = document.getElementById('remoteBox');
        remoteBox.innerHTML = '';
        const rv = document.createElement('video');
        rv.autoplay = true; rv.playsInline = true; rv.srcObject = e.streams[0];
        remoteBox.appendChild(rv);
        document.getElementById('remoteStatus').style.background = 'linear-gradient(90deg,var(--accent),#b86bff)';
      };

      peerConnection.onicecandidate = (event) => {
        if (event.candidate && partnerId) {
          socket.emit('signal', { to: partnerId, data: { type:'candidate', candidate: event.candidate } });
        }
      };

      peerConnection.onconnectionstatechange = () => {
        console.log('pc state', peerConnection.connectionState);
        if (peerConnection.connectionState === 'failed' || peerConnection.connectionState === 'disconnected') {
          notify('Connection problem â€” finding a new partner');
          setTimeout(()=> nextPartner(), 1000);
        }
      };

      return peerConnection;
    }

    async function handleOutgoingOffer(){
      try {
        await createPeer();
        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);
        socket.emit('signal', { to: partnerId, data: { type:'offer', offer } });
      } catch(e){ console.error('offer error', e); }
    }

    async function handleIncomingOffer(offer, from){
      try {
        partnerId = from;
        await createPeer();
        await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);
        socket.emit('signal', { to: from, data: { type:'answer', answer } });
      } catch(e){ console.error('incoming offer error', e); }
    }

    function cleanupPeer(){
      try {
        if (peerConnection) {
          peerConnection.ontrack = null;
          peerConnection.onicecandidate = null;
          peerConnection.close();
        }
      } catch(e){ console.warn(e); }
      peerConnection = null;
      partnerId = null;
    }

    function resetRemotePlaceholder(){
      const r = document.getElementById('remoteBox');
      if (r) r.innerHTML = '<div class="label">Partner</div><div id="remoteStatus" class="status"></div><div class="video-placeholder">Not connected</div>';
      try { document.getElementById('remoteStatus').style.background = 'rgba(255,255,255,0.06)'; } catch(e){}
    }

    // ====== CHAT ======
    window.handleChatInput = function(e){
      if (e.key === 'Enter' && !e.shiftKey){
        e.preventDefault();
        const t = e.target; const text = t.value.trim();
        if (!text) return;
        sendChatMessage(text); t.value = '';
      }
    };

    function sendChatMessage(text){
      if (!text || !text.trim()) return;
      if (!partnerId) { addMessage('System','Waiting for partner to connect before sending...', false); return; }
      socket.emit('chatMessage', { text });
      addMessage('You', text, true);
    }
    window.sendChatFromUI = function(){ const el = document.getElementById('chatInput'); if (!el) return; const txt = el.value.trim(); if (!txt) return; sendChatMessage(txt); el.value=''; };

    function addMessage(sender, text, isOwn){
      const box = document.getElementById('chatMessages'); if (!box) return;
      const d = document.createElement('div'); d.className = 'message ' + (isOwn ? 'own' : 'other'); d.innerHTML = '<strong>' + escapeHtml(sender) + ':</strong> ' + escapeHtml(text);
      box.appendChild(d); box.scrollTop = box.scrollHeight;
    }
    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    // ====== ACTIONS ======
    window.startChatFromLanding = async function(){
      await initSocket();
      await prepareLocalStreamIfNeeded();
      socket.emit('find-partner');
      notify('Searching for a partner...');
    };

    window.nextPartner = function(){
      // remove listeners to avoid duplicates
      if (socket){
        socket.removeAllListeners('signal'); socket.removeAllListeners('partner-found'); socket.removeAllListeners('chatMessage');
      }
      cleanupPeer();
      document.getElementById('chatMessages').innerHTML = '';
      resetRemotePlaceholder();
      wireSocket(); // re-wire once more
      if (socket) { socket.emit('find-partner'); notify('Finding a new partner...'); } else initSocket().then(()=> socket.emit('find-partner'));
    };

    window.endChat = function(){
      if (socket && partnerId) socket.emit('end-chat');
      cleanupPeer(); notify('Chat ended');
    };

    window.reportUser = function(){
      try {
        const payload = { userEmail: localStorage.getItem('email') || 'anon', reason: 'Inappropriate behavior' };
        fetch(API_BASE + '/api/report', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
      } catch(e){ console.warn(e); }
      notify('User reported');
    };

    window.toggleAudio = function(){
      if (!localStream) return notify('No local stream');
      isMuted = !isMuted; localStream.getAudioTracks().forEach(t=> t.enabled = !isMuted);
      document.getElementById('muteBtn').textContent = isMuted ? 'Unmute' : 'Mute';
    };
    window.toggleCamera = function(){
      if (!localStream) return notify('No local stream');
      cameraOff = !cameraOff; localStream.getVideoTracks().forEach(t=> t.enabled = !cameraOff);
      document.getElementById('camBtn').textContent = cameraOff ? 'Camera On' : 'Camera';
    };

    // ====== AUTH ======
    window.handleAuth = async function(e){
      e && e.preventDefault && e.preventDefault();
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value || '';
      const department = document.getElementById('department').value || '';
      try {
        const res = await fetch(API_BASE + '/api/auth', { method:'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ email, password, department }) });
        if (!res.ok) throw new Error(await res.text());
        const data = await res.json();
        localStorage.setItem('token', data.token); localStorage.setItem('email', data.email);
        setSignedEmail(data.email); closeAuthModal(); notify('Welcome ' + data.email);
        // auto-start chat as logged user
        await initSocket(); await prepareLocalStreamIfNeeded(); socket.emit('find-partner');
      } catch(err){
        console.error(err);
        notify('Login failed: ' + (err.message || err));
      }
    };

    window.logout = function(){ localStorage.removeItem('token'); localStorage.removeItem('email'); setSignedEmail('Anonymous'); notify('Logged out'); };

    // ====== INIT on load ======
    window.addEventListener('load', ()=> {
      const em = localStorage.getItem('email'); if (em) setSignedEmail(em);
      // initialize socket in background (optional)
      initSocket().catch(e=>console.warn('socket init fail', e));
    });

    // expose for debugging
    window._uc_state = ()=> ({ socket: !!socket, partnerId, pc: !!peerConnection, localStream: !!localStream });

  })();
  </script>
</body>
</html>
