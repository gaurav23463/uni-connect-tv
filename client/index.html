<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>UniConnect TV ‚Äî Demo</title>

  <!-- Fonts (system stack for performance) -->
  <style>
    :root{
      --bg:#0b0d12;
      --card-bg: rgba(255,255,255,0.03);
      --glass-border: rgba(255,255,255,0.06);
      --neon-1:#5b8cff;
      --neon-2:#9b5bff;
      --accent:#8be4ff;
      --text:#e6eef8;
      --muted:#98a0b3;
      --success:#4ade80;
      --danger:#ff6b6b;
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#05060a 0%, #0b0d12 100%);font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;color:var(--text);-webkit-font-smoothing:antialiased}
    a{color:inherit}
    button{font-family:inherit}
    /* container */
    .wrap{max-width:1200px;margin:28px auto;padding:18px}
    header{display:flex;align-items:center;justify-content:space-between;padding:12px 0}
    .brand{display:flex;gap:12px;align-items:center}
    .logo {
      width:56px;height:56px;border-radius:12px;
      background:linear-gradient(135deg,var(--neon-1),var(--neon-2));
      display:grid;place-items:center;font-weight:800;color:white;box-shadow:0 12px 40px rgba(91,140,255,0.18);
      transform:translateZ(24px);
    }
    .title{font-size:18px;font-weight:700;letter-spacing:0.2px}
    .subtitle{font-size:12px;color:var(--muted)}

    /* controls */
    .controls{display:flex;gap:10px;align-items:center}
    .btn { padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,0.04); background:var(--card-bg); color:var(--text); cursor:pointer; font-weight:700; }
    .btn.primary{ background: linear-gradient(90deg,var(--neon-1),var(--neon-2)); color:#fff; box-shadow:0 12px 30px rgba(123,98,255,0.14);}
    .theme-toggle{font-size:14px}

    /* board */
    .stage{display:grid;grid-template-columns: 1fr 360px; gap:22px; margin-top:22px; align-items:start; perspective:1300px}
    @media (max-width:1000px){ .stage{grid-template-columns:1fr; padding:0 14px} .right-col{order:2} }

    /* video area (3D glass) */
    .video-area{display:grid;grid-template-columns:1fr 1fr; gap:20px; transform-style:preserve-3d}
    @media (max-width:900px){ .video-area{grid-template-columns:1fr} }

    .video-card{
      min-height:360px;border-radius:var(--radius);position:relative;overflow:hidden;
      background: linear-gradient(180deg, rgba(255,255,255,0.025), rgba(255,255,255,0.01));
      border:1px solid var(--glass-border);
      box-shadow: 0 24px 60px rgba(3,6,18,0.65);
      display:flex;align-items:center;justify-content:center; transition: transform .45s cubic-bezier(.2,.9,.3,1), box-shadow .45s;
      transform-style:preserve-3d;
    }
    .video-card .bg-layer{ position:absolute; inset:0; pointer-events:none; background:
      radial-gradient(600px 200px at 10% 10%, rgba(91,140,255,0.06), transparent 8%),
      radial-gradient(400px 160px at 85% 85%, rgba(155,91,255,0.05), transparent 10%); filter:blur(28px); transform: translateZ(-40px) scale(1.06);}
    .video-label{position:absolute;left:14px;top:14px;padding:8px 12px;border-radius:12px;background:rgba(0,0,0,0.36);font-weight:700;backdrop-filter:blur(6px)}
    .status-indicator{position:absolute;right:12px;top:14px;width:12px;height:12px;border-radius:50%;box-shadow: 0 8px 20px rgba(0,0,0,0.4)}
    .status-indicator.offline{background:rgba(255,255,255,0.06)}
    .status-indicator.online{background:linear-gradient(90deg,var(--neon-1),var(--neon-2))}

    .video-placeholder{color:var(--muted);font-weight:600}

    .video-card video{ width:100%; height:100%; object-fit:cover; border-radius:calc(var(--radius) - 6px); transform:translateZ(40px); }

    .video-card:hover{ transform: translateY(-8px) rotateX(4deg) translateZ(28px); box-shadow:0 40px 100px rgba(8,10,30,0.7);}

    /* right column (controls + chat) */
    .right-col{display:flex;flex-direction:column;gap:18px}
    .panel{background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:14px;border-radius:14px;border:1px solid var(--glass-border); box-shadow: 0 12px 36px rgba(2,4,12,0.6)}
    .panel h3{margin:0 0 10px 0;font-size:14px}
    #chatMessages{height:380px; overflow:auto; padding:8px; display:flex; flex-direction:column; gap:8px; background: linear-gradient(180deg, rgba(255,255,255,0.01), transparent); border-radius:10px}
    .message{ padding:8px 10px; border-radius:10px; max-width:85%; font-size:14px; line-height:1.25 }
    .message.own{ align-self:flex-end; background: linear-gradient(90deg,#0f1724,#0b1220); color:var(--text); border:1px solid rgba(255,255,255,0.02) }
    .message.other{ align-self:flex-start; background: rgba(255,255,255,0.03); color:var(--text) }
    .chat-input{display:flex; gap:10px; margin-top:10px}
    .chat-input textarea{flex:1; resize:none; padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04); background:transparent; color:var(--text)}
    .small{font-size:13px;color:var(--muted)}

    /* footer */
    footer{margin-top:22px;color:var(--muted);font-size:13px;text-align:center}

    /* notifications */
    .notification{position:fixed;top:22px;right:22px;padding:12px 16px;border-radius:10px;background:rgba(12,14,22,0.95);color:var(--text);box-shadow:0 12px 40px rgba(6,8,18,0.6);z-index:9999;border-left:4px solid var(--neon-1)}

    @media (max-width:600px){
      .video-card{min-height:220px}
      .stage{grid-template-columns:1fr}
      .wrap{padding:12px}
    }

    /* reduced motion fallback */
    @media (prefers-reduced-motion: reduce){
      .video-card, .video-card:hover{ transform:none !important; transition:none !important}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">UC</div>
        <div>
          <div class="title">UniConnect TV</div>
          <div class="subtitle">Connecting Students, Building Conversations</div>
        </div>
      </div>

      <div class="controls">
        <button class="btn" onclick="showModal('auth')">Log in</button>
        <button class="btn" onclick="startDemo()">Try Demo</button>
        <button class="btn primary" onclick="startChat()">Start Chat</button>
      </div>
    </header>

    <main class="stage">
      <section class="left-col">
        <div class="video-area" id="videoStage">
          <div class="video-card" id="localCard" data-role="local">
            <div class="bg-layer"></div>
            <div class="video-label">You</div>
            <div id="localStatus" class="status-indicator offline"></div>
            <div class="video-placeholder">üìπ Camera loading‚Ä¶</div>
          </div>

          <div class="video-card" id="remoteCard" data-role="remote">
            <div class="bg-layer"></div>
            <div class="video-label">Partner</div>
            <div id="remoteStatus" class="status-indicator offline"></div>
            <div class="video-placeholder">‚è≥ Finding Partner‚Ä¶</div>
          </div>
        </div>

        <div style="margin-top:16px; display:flex; gap:12px;">
          <button class="btn" onclick="nextPartner()">Next</button>
          <button class="btn" onclick="endChat()">End</button>
          <button class="btn" onclick="reportUser()">Report</button>
          <button class="btn" id="muteBtn" onclick="toggleAudio()">Mute</button>
          <button class="btn" id="camBtn" onclick="toggleCamera()">Camera</button>
        </div>
      </section>

      <aside class="right-col">
        <div class="panel">
          <h3>Chat</h3>
          <div id="chatMessages" aria-live="polite"></div>

          <div class="chat-input">
            <textarea id="chatInput" rows="2" placeholder="Type message and press Enter..." onkeydown="handleChatInput(event)"></textarea>
            <button class="btn primary" onclick="sendChatFromUI()">Send</button>
          </div>

          <div style="margin-top:12px" class="small">Tip: Use demo to practice. Use "Next" to find new people.</div>
        </div>

        <div class="panel">
          <h3>Profile & Quick Actions</h3>
          <div class="small">You are anonymous until you verify. Add tags to get better matches (coming soon).</div>
        </div>
      </aside>
    </main>

    <footer>¬© UniConnect TV ‚Äî built by Gaurav Tripathi</footer>
  </div>

  <!-- Auth Modal (simple) -->
  <div id="authModal" class="modal" style="display:none;position:fixed;inset:0;background:rgba(2,4,12,0.6);z-index:9998;align-items:center;justify-content:center">
    <div style="width:320px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.04)">
      <h3 style="margin:0 0 12px 0">Login / Register</h3>
      <input id="email" placeholder="Email" style="width:100%;padding:10px;border-radius:8px;margin-bottom:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text)">
      <input id="password" type="password" placeholder="Password" style="width:100%;padding:10px;border-radius:8px;margin-bottom:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text)">
      <input id="department" placeholder="Department (optional)" style="width:100%;padding:10px;border-radius:8px;margin-bottom:12px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text)">
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button class="btn" onclick="hideModal('auth')">Cancel</button>
        <button class="btn primary" onclick="handleAuth(event)">Login</button>
      </div>
    </div>
  </div>

  <!-- Socket.io -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

  <!-- Main App Script -->
  <script>
  (function(){
    // CONFIG
    const API_BASE = window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1"
      ? "http://localhost:5000"
      : "https://uni-connect-tv-5.onrender.com";

    // State
    let socket = null;
    let peerConnection = null;
    let partnerId = null;
    let localStream = null;
    let isMuted = false;
    let cameraOff = false;

    // Notification dedupe
    let __lastNotif = { text:'', time:0 };
    function showNotification(text, type='info'){
      const now = Date.now();
      if (text === __lastNotif.text && now - __lastNotif.time < 2500) return;
      __lastNotif = { text, time: now };
      const n = document.createElement('div'); n.className = 'notification'; n.textContent = text;
      document.body.appendChild(n); setTimeout(()=>n.remove(), 3000);
    }

    // Modal
    window.showModal = function(type){
      if(type === 'auth') document.getElementById('authModal').style.display = 'flex';
    };
    window.hideModal = function(type){
      if(type === 'auth') document.getElementById('authModal').style.display = 'none';
    };

    // Init socket safely
    async function initApp(){
      if (socket) return;
      socket = io(API_BASE, { transports:['websocket'] });

      // Guard: remove old listeners if reloading
      if (window.__uni_socket_inited) {
        socket.removeAllListeners();
      } else {
        window.__uni_socket_inited = true;
      }

      initSocketListeners();
      console.log('Socket init ->', API_BASE);
    }
    window.initApp = initApp;

    // Socket listeners centralized
    function initSocketListeners(){
      socket.removeAllListeners();

      socket.on('connect', ()=> console.log('socket connected', socket.id));
      socket.on('waiting', ()=> showNotification('‚è≥ Waiting for another user...', 'info'));

      socket.on('partner-found', async (id)=>{
        partnerId = id;
        showNotification('üéâ Partner found ‚Äî connecting...', 'success');
        // clear chat
        document.getElementById('chatMessages').innerHTML = '';
        await handleOfferAnswerAsNeeded();
      });

      socket.on('signal', async ({ from, data })=>{
        partnerId = from;
        try {
          if (data.type === 'offer') {
            // incoming offer
            await handleIncomingOffer(data.offer, from);
          } else if (data.type === 'answer') {
            // remote answer to our offer
            if (peerConnection && (peerConnection.signalingState === 'have-local-offer' || peerConnection.signalingState === 'stable')) {
              await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
            } else {
              console.warn('Ignored answer due to wrong signalingState', peerConnection ? peerConnection.signalingState : 'no-pc');
            }
          } else if (data.type === 'candidate') {
            if (peerConnection) await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
          }
        } catch(e){ console.error('signal handler err',e) }
      });

      socket.on('partner-left', ()=>{
        showNotification('‚ùå Partner disconnected', 'warning');
        cleanupPeer();
        resetRemotePlaceholder();
      });

      socket.on('chatMessage', (payload)=>{
        const text = normalizeIncoming(payload);
        addMessage('Partner', text, false);
      });
    }

    // Normalize incoming chat payload
    function normalizeIncoming(payload){
      if (!payload) return '';
      if (typeof payload === 'string') {
        try { const p = JSON.parse(payload); return p.text || p.msg || payload; } catch { return payload; }
      }
      if (payload.text) return payload.text;
      if (payload.msg) return (typeof payload.msg === 'string') ? payload.msg : payload.msg.text || JSON.stringify(payload.msg);
      return JSON.stringify(payload);
    }

    // TURN fetch
    async function getIceServers(){
      try {
        const r = await fetch(`${API_BASE}/api/turn`);
        if (!r.ok) throw new Error('turn fetch failed');
        const j = await r.json();
        return j.iceServers || [{ urls:'stun:stun.l.google.com:19302' }];
      } catch(e){
        console.warn('TURN fetch failed, fallback STUN', e);
        return [{ urls:'stun:stun.l.google.com:19302' }];
      }
    }

    // create peer connection and start local media
    async function prepareLocalStreamIfNeeded(){
      if (localStream) return;
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ video: { width:{ideal:640}, height:{ideal:480} }, audio:true });
        const localCard = document.getElementById('localCard');
        localCard.innerHTML = ''; // clear placeholder
        const v = document.createElement('video');
        v.autoplay = true; v.muted = true; v.playsInline = true; v.srcObject = localStream;
        localCard.appendChild(v);
        document.getElementById('localStatus').classList.remove('offline'); document.getElementById('localStatus').classList.add('online');
      } catch(e){
        console.error('getUserMedia err', e);
        showNotification('‚ö†Ô∏è Camera/mic access denied', 'danger');
      }
    }

    async function createPeerConnection(){
      const iceServers = await getIceServers();
      const config = { iceServers, iceCandidatePoolSize:10 };
      peerConnection = new RTCPeerConnection(config);

      // add local tracks
      if (!localStream) await prepareLocalStreamIfNeeded();
      localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

      peerConnection.ontrack = (ev) => {
        const remoteCard = document.getElementById('remoteCard');
        remoteCard.innerHTML = '';
        const rv = document.createElement('video');
        rv.autoplay = true; rv.playsInline = true; rv.srcObject = ev.streams[0];
        remoteCard.appendChild(rv);
        document.getElementById('remoteStatus').classList.remove('offline'); document.getElementById('remoteStatus').classList.add('online');
      };

      peerConnection.onicecandidate = (event) => {
        if (event.candidate && partnerId) {
          socket.emit('signal', { to: partnerId, data: { type:'candidate', candidate: event.candidate } });
        }
      };

      peerConnection.onconnectionstatechange = () => {
        console.log('pc state', peerConnection.connectionState);
        if (peerConnection.connectionState === 'failed' || peerConnection.connectionState === 'disconnected') {
          showNotification('‚ö†Ô∏è Connection problem ‚Äî trying new partner', 'warning');
          // auto try to reconnect by triggering nextPartner
          setTimeout(() => { nextPartner(); }, 1200);
        }
      };

      return peerConnection;
    }

    // handshake flow when we are initiator
    async function handleOfferAnswerAsNeeded(){
      try {
        await createPeerConnection();
        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);
        socket.emit('signal', { to: partnerId, data: { type:'offer', offer } });
      } catch(e){ console.error('offer flow err', e) }
    }

    // when receiving offer from other side
    async function handleIncomingOffer(offer, from){
      try {
        partnerId = from;
        await createPeerConnection();
        await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);
        socket.emit('signal', { to: from, data: { type:'answer', answer } });
      } catch(e){ console.error('incoming offer err', e) }
    }

    // cleanup
    function cleanupPeer(){
      try {
        if (peerConnection) {
          peerConnection.ontrack = null;
          peerConnection.onicecandidate = null;
          peerConnection.close();
        }
      } catch(e){}
      try { document.getElementById('remoteCard').innerHTML = '<div class="bg-layer"></div><div class="video-label">Partner</div><div id="remoteStatus" class="status-indicator offline"></div><div class="video-placeholder">‚è≥ Finding Partner‚Ä¶</div>'; } catch(e){}
      peerConnection = null; partnerId = null;
    }

    function resetRemotePlaceholder(){
      const remoteCard = document.getElementById('remoteCard');
      remoteCard.innerHTML = '<div class="bg-layer"></div><div class="video-label">Partner</div><div id="remoteStatus" class="status-indicator offline"></div><div class="video-placeholder">‚è≥ Finding Partner‚Ä¶</div>';
    }

    // CHAT
    window.handleChatInput = function(e){
      if (e.key === 'Enter' && !e.shiftKey){
        e.preventDefault();
        const t = e.target; const text = t.value.trim();
        if (!text) return;
        sendChatMessage(text);
        t.value = '';
      }
    };

    function sendChatMessage(text){
      if (!text || !text.trim()) return;
      if (!partnerId) { addMessage('System', '‚è≥ Waiting for a partner to connect before sending...', false); return; }
      socket.emit('chatMessage', { text });
      addMessage('You', text, true);
    }
    window.sendChatFromUI = function(){ const el=document.getElementById('chatInput'); sendChatMessage(el.value.trim()); el.value=''; };

    function addMessage(sender, text, isOwn){
      const box = document.getElementById('chatMessages');
      const div = document.createElement('div'); div.className = 'message ' + (isOwn ? 'own' : 'other');
      div.innerHTML = `<strong>${sender}:</strong> ${escapeHtml(text)}`;
      box.appendChild(div); box.scrollTop = box.scrollHeight;
    }
    function escapeHtml(s){ return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    // UI actions
    window.startChat = async function(){
      await initApp();
      await prepareLocalStreamIfNeeded();
      socket.emit('find-partner');
      showNotification('üîç Searching for a partner...', 'info');
    };

    window.startDemo = function(){
      // demo mode: fake partner responses
      document.getElementById('landing')?.remove?.();
      document.getElementById('chatMessages').innerHTML = '';
      addMessage('System', 'üé¨ Demo mode: You are chatting with a virtual partner.', false);
      setTimeout(()=> addMessage('Partner','Hi! I am your demo partner üòä', false), 700);
    };

    window.nextPartner = function(){
      // remove listeners to avoid duplicates
      if (socket){
        socket.removeAllListeners('signal');
        socket.removeAllListeners('partner-found');
        socket.removeAllListeners('chatMessage');
      }
      cleanupPeer();
      document.getElementById('chatMessages').innerHTML = '';
      resetRemotePlaceholder();
      initSocketListeners();
      if (socket) { socket.emit('find-partner'); showNotification('üîÑ Searching for a new partner...', 'info'); }
      else initApp().then(()=> socket.emit('find-partner'));
    };

    window.endChat = function(){
      if (socket && partnerId) socket.emit('end-chat');
      cleanupPeer();
      showNotification('Chat ended.', 'info');
    };

    window.reportUser = function(){
      try {
        const payload = { userEmail: localStorage.getItem('email') || 'anon', reason: 'Inappropriate behavior' };
        fetch(`${API_BASE}/api/report`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
      } catch(e){ console.warn(e) }
      showNotification('User reported.', 'warning');
    };

    // toggles
    window.toggleAudio = function(){
      if (!localStream) return showNotification('No local stream', 'warning');
      isMuted = !isMuted; localStream.getAudioTracks().forEach(t => t.enabled = !isMuted);
      document.getElementById('muteBtn').textContent = isMuted ? 'Unmute' : 'Mute';
    };
    window.toggleCamera = function(){
      if (!localStream) return showNotification('No local stream', 'warning');
      cameraOff = !cameraOff; localStream.getVideoTracks().forEach(t => t.enabled = !cameraOff);
      document.getElementById('camBtn').textContent = cameraOff ? 'Camera On' : 'Camera';
    };

    // Auth (simple auth route hooking)
    window.handleAuth = async function(e){
      e && e.preventDefault && e.preventDefault();
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const department = document.getElementById('department').value;
      try {
        const res = await fetch(`${API_BASE}/api/auth`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ email, password, department }) });
        if (!res.ok) throw new Error(await res.text());
        const data = await res.json();
        localStorage.setItem('token', data.token); localStorage.setItem('email', data.email);
        hideModal('auth');
        showNotification('Welcome ' + data.email, 'success');
        startChat();
      } catch(err){ console.error(err); showNotification('Login failed: '+ (err.message||err), 'danger'); }
    };

    // normalize & escape helper
    function normalizePayload(p){ return (typeof p === 'string') ? p : p.text || p.msg || JSON.stringify(p); }

    // util: escape injection (used earlier)
    // initialize on load
    window.addEventListener('load', ()=> { initApp().catch(e=>console.warn(e)); });

    // tiny 3D tilt effect for stage (non-blocking)
    (function(){
      const stage = document.getElementById('videoStage');
      if (!stage || window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;
      function onmove(e){
        const r = stage.getBoundingClientRect(), cx = r.left + r.width/2, cy = r.top + r.height/2;
        const dx = (e.clientX - cx)/r.width, dy = (e.clientY - cy)/r.height;
        Array.from(stage.querySelectorAll('.video-card')).forEach((card,i)=>{
          const depth = i===0?8:18;
          const rx = dy*depth, ry = dx*depth;
          card.style.transform = `rotateX(${ -rx }deg) rotateY(${ ry }deg) translateZ(${ depth }px)`;
        });
      }
      window.addEventListener('mousemove', onmove);
      window.addEventListener('mouseleave', ()=>{ Array.from(stage.querySelectorAll('.video-card')).forEach(c=>c.style.transform=''); });
    })();
  })();
  </script>
</body>
</html>
