<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Uni-Connect TV - Student Video Chat</title>
  <style>
    /* ---------- YOUR STYLES (kept & cleaned) ---------- */
    :root{
      --bg-dark:#0f0f10;
      --accent-cyan:#00f0ff;
      --accent-pink:#ff00c8;
      --text-white:#ffffff;
      --glass-bg:rgba(255,255,255,0.04);
      --glass-border:rgba(255,255,255,0.08);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;width:100%;font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;background:var(--bg-dark);color:var(--text-white);overflow-x:hidden}
    /* animated background */
    .animated-bg{position:fixed;inset:0;z-index:0;pointer-events:none}
    .bubble{position:absolute;bottom:-120px;border-radius:50%;opacity:.25;filter:blur(18px);animation:float-up 16s linear infinite}
    .bubble:nth-child(1){left:6%;width:90px;height:90px;background:radial-gradient(circle,var(--accent-cyan) 0%,transparent 70%);animation-delay:0s}
    .bubble:nth-child(2){left:28%;width:140px;height:140px;background:radial-gradient(circle,var(--accent-cyan) 0%,transparent 70%);animation-delay:3s}
    .bubble:nth-child(3){left:50%;width:110px;height:110px;background:radial-gradient(circle,var(--accent-cyan) 0%,transparent 70%);animation-delay:6s}
    .bubble:nth-child(4){left:72%;width:100px;height:100px;background:radial-gradient(circle,var(--accent-pink) 0%,transparent 70%);animation-delay:9s}
    .bubble:nth-child(5){left:86%;width:130px;height:130px;background:radial-gradient(circle,var(--accent-pink) 0%,transparent 70%);animation-delay:12s}
    @keyframes float-up{0%{transform:translateY(0) scale(1);opacity:.25}50%{opacity:.45}100%{transform:translateY(-120vh) scale(1.2);opacity:0}}
    /* landing */
    #landing{position:relative;z-index:1;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100%;padding:24px;transition:opacity .5s,transform .5s}
    #landing.hidden{opacity:0;transform:scale(.98);pointer-events:none}
    .logo-3d{font-size:64px;font-weight:900;background:linear-gradient(135deg,var(--accent-cyan),var(--accent-pink));-webkit-background-clip:text;background-clip:text;color:transparent;text-shadow:0 0 40px rgba(0,240,255,.3);margin-bottom:18px;animation:glow-pulse 3s infinite}
    @keyframes glow-pulse{0%,100%{filter:drop-shadow(0 0 20px rgba(0,240,255,.45))}50%{filter:drop-shadow(0 0 40px rgba(255,0,200,.5))}}
    .tagline{font-size:18px;color:rgba(255,255,255,.75);margin-bottom:34px;text-align:center}
    .glass-btn{background:var(--glass-bg);backdrop-filter:blur(12px);border:1px solid var(--glass-border);padding:14px 36px;border-radius:12px;color:var(--text-white);font-weight:700;cursor:pointer;margin:8px;transition:all .25s;box-shadow:0 8px 28px rgba(0,0,0,.25)}
    .glass-btn.primary{background:linear-gradient(135deg,var(--accent-cyan),var(--accent-pink));border:0}
    .glass-btn:hover{transform:translateY(-6px);box-shadow:0 18px 40px rgba(0,0,0,.35)}
    /* modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(6px);display:none;align-items:center;justify-content:center;z-index:1000}
    .modal.active{display:flex}
    .modal-content{background:var(--glass-bg);backdrop-filter:blur(14px);border:1px solid var(--glass-border);border-radius:16px;padding:28px;width:380px;max-width:95%}
    .modal-header{font-size:24px;font-weight:800;margin-bottom:18px;background:linear-gradient(135deg,var(--accent-cyan),var(--accent-pink));-webkit-background-clip:text;color:transparent}
    .form-group{margin-bottom:12px}
    .form-group input,.form-group select{width:100%;padding:10px;border-radius:8px;border:1px solid var(--glass-border);background:rgba(255,255,255,.03);color:var(--text-white)}
    /* chat interface */
    #chatInterface{position:relative;z-index:1;display:none;flex-direction:column;height:100vh;min-height:600px;opacity:0;transform:scale(.98);transition:all .4s}
    #chatInterface.active{display:flex;opacity:1;transform:scale(1)}
    .top-nav{display:flex;align-items:center;justify-content:space-between;padding:12px 22px;background:var(--glass-bg);backdrop-filter:blur(8px);border-bottom:1px solid var(--glass-border)}
    .nav-logo{font-weight:800;background:linear-gradient(135deg,var(--accent-cyan),var(--accent-pink));-webkit-background-clip:text;color:transparent}
    .profile-avatar{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;background:linear-gradient(135deg,var(--accent-cyan),var(--accent-pink));cursor:pointer}
    .main-content{display:flex;gap:18px;padding:20px;flex:1;overflow:hidden}
    .video-section{flex:1;display:flex;flex-direction:column;gap:16px}
    .video-grid{display:grid;grid-template-columns:1fr 1fr;gap:18px;flex:1}
    .video-box{position:relative;background:var(--glass-bg);backdrop-filter:blur(8px);border-radius:16px;border:1px solid var(--glass-border);overflow:hidden;display:flex;align-items:center;justify-content:center;min-height:320px}
    .video-box.active{box-shadow:0 24px 64px rgba(0,240,255,.06);border-color:var(--accent-cyan)}
    .video-box video{width:100%;height:100%;object-fit:cover;display:block}
    .video-placeholder{font-size:44px;opacity:.28}
    .status-indicator{position:absolute;top:14px;right:14px;width:12px;height:12px;border-radius:50%;background:#4ade80;box-shadow:0 0 14px #4ade80;animation:pulse .9s infinite}
    .status-indicator.offline{background:#ef4444;box-shadow:0 0 14px #ef4444}
    @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.2)}100%{transform:scale(1)}}
    .video-label{position:absolute;bottom:14px;left:14px;padding:8px 12px;border-radius:8px;background:rgba(0,0,0,.45);font-weight:700}
    .controls{display:flex;justify-content:center;gap:12px;padding:6px}
    .control-btn{width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;background:var(--glass-bg);border:1px solid var(--glass-border);cursor:pointer}
    .control-btn.danger{border-color:#ef4444}
    .chat-sidebar{width:340px;background:var(--glass-bg);backdrop-filter:blur(8px);border:1px solid var(--glass-border);border-radius:12px;display:flex;flex-direction:column;overflow:hidden}
    .chat-header{padding:16px;border-bottom:1px solid var(--glass-border);font-weight:800}
    .chat-messages{flex:1;padding:16px;overflow:auto;display:flex;flex-direction:column;gap:12px}
    .message{padding:10px 14px;border-radius:12px;max-width:80%}
    .message.sent{align-self:flex-end;background:linear-gradient(135deg,var(--accent-cyan),var(--accent-pink));color:#0b0b0b}
    .message.received{align-self:flex-start;background:rgba(255,255,255,.05)}
    .chat-input-area{padding:14px;border-top:1px solid var(--glass-border);display:flex;gap:10px}
    .chat-input{flex:1;padding:10px;border-radius:10px;border:1px solid var(--glass-border);background:rgba(255,255,255,.03);color:var(--text-white)}
    .send-btn{padding:10px 12px;border-radius:10px;background:linear-gradient(135deg,var(--accent-cyan),var(--accent-pink));border:none;cursor:pointer}
    .floating-toolbar{position:fixed;right:18px;top:50%;transform:translateY(-50%);background:var(--glass-bg);border:1px solid var(--glass-border);padding:10px;border-radius:12px;display:flex;flex-direction:column;gap:10px;z-index:1100}
    .toast-container{position:fixed;right:20px;top:72px;display:flex;flex-direction:column;gap:10px;z-index:1200}
    .toast{background:var(--glass-bg);padding:10px 14px;border-radius:10px;border:1px solid var(--glass-border);min-width:220px}
    footer{padding:10px;text-align:center;background:var(--glass-bg);border-top:1px solid var(--glass-border)}

    /* responsive */
    @media(max-width:900px){
      .video-grid{grid-template-columns:1fr}
      .chat-sidebar{width:100%;position:fixed;right:0;top:0;bottom:0;transform:translateX(100%);transition:transform .3s}
      .chat-sidebar.active{transform:translateX(0)}
      .floating-toolbar{right:10px;top:auto;bottom:90px;transform:none}
    }
  </style>
</head>
<body>
  <!-- Animated background -->
  <div class="animated-bg" aria-hidden="true">
    <div class="bubble"></div>
    <div class="bubble"></div>
    <div class="bubble"></div>
    <div class="bubble"></div>
    <div class="bubble"></div>
  </div>

  <!-- Landing -->
  <main id="landing">
    <h1 class="logo-3d">Uni-Connect TV</h1>
    <p class="tagline">Connect with students worldwide</p>
    <div>
      <button class="glass-btn primary" id="loginBtn">Login with Email</button>
      <button class="glass-btn" id="demoChatBtn">Join Demo Chat</button>
    </div>
  </main>

  <!-- Login Modal -->
  <div class="modal" id="loginModal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true">
      <div class="modal-header">Welcome Back</div>
      <form id="loginForm">
        <div class="form-group">
          <label for="email">Email</label>
          <input id="email" type="email" placeholder="student@university.edu" required />
        </div>
        <div class="form-group">
          <label for="password">Password</label>
          <input id="password" type="password" placeholder="Password" required />
        </div>
        <div class="form-group">
          <label for="department">Department</label>
          <select id="department" required>
            <option value="">Select Department</option>
            <option value="computer-science">Computer Science</option>
            <option value="engineering">Engineering</option>
            <option value="business">Business</option>
            <option value="arts">Arts</option>
            <option value="science">Science</option>
            <option value="medicine">Medicine</option>
          </select>
        </div>
        <div style="display:flex;gap:10px;margin-top:12px">
          <button type="button" class="glass-btn" id="cancelBtn">Cancel</button>
          <button type="submit" class="glass-btn primary">Login</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Chat Interface -->
  <div id="chatInterface" aria-hidden="true" style="display:none">
    <nav class="top-nav">
      <div class="nav-logo">Uni-Connect TV</div>
      <div style="display:flex;gap:12px;align-items:center">
        <div class="profile-avatar" id="profileAvatar">U</div>
        <button class="glass-btn" id="logoutBtn" style="padding:8px 12px">Logout</button>
      </div>
    </nav>

    <section class="main-content">
      <div class="video-section">
        <div class="video-grid">
          <div class="video-box active" id="videoLocalBox">
            <div class="video-placeholder">üé•</div>
            <video id="videoLocal" autoplay muted playsinline style="display:none"></video>
            <div class="status-indicator" id="localStatus"></div>
            <div class="video-label">You</div>
          </div>

          <div class="video-box" id="videoRemoteBox">
            <div class="video-placeholder">üë§</div>
            <video id="videoRemote" autoplay playsinline style="display:none"></video>
            <div class="status-indicator offline" id="remoteStatus"></div>
            <div class="video-label">Partner</div>
          </div>
        </div>

        <div class="controls" style="padding-top:10px">
          <button class="control-btn" id="btnMute" title="Mute/Unmute">üé§</button>
          <button class="control-btn" id="btnCamera" title="Camera On/Off">üé•</button>
          <button class="control-btn" id="btnNext" title="Next Partner">üîÑ</button>
          <button class="control-btn danger" id="btnReport" title="Report">‚ö†Ô∏è</button>
          <button class="control-btn danger" id="btnEnd" title="End Chat">üö™</button>
        </div>
      </div>

      <aside class="chat-sidebar" id="chatSidebar">
        <div class="chat-header">üí¨ Chat Messages</div>
        <div class="chat-messages" id="chatMessages">
          <div class="message received">Welcome to Uni-Connect TV! üëã</div>
        </div>
        <div class="chat-input-area">
          <input id="chatInput" class="chat-input" placeholder="Type a message..." />
          <button id="sendBtn" class="send-btn">üì§</button>
        </div>
      </aside>
    </section>

    <footer>
      <div style="margin-bottom:8px">Made with ‚ù§Ô∏è by Gaurav Tripathi</div>
      <div style="font-size:13px;color:rgba(255,255,255,.6)">Connect with students worldwide</div>
    </footer>
  </div>

  <div class="floating-toolbar" id="floatingToolbar" style="display:none">
    <button class="glass-btn" id="filterBtn" title="Toggle filter">üé®</button>
    <button class="glass-btn" id="themeBtn" title="Toggle theme">üî¶</button>
    <button class="glass-btn" id="blurBtn" title="Toggle blur">üí´</button>
  </div>

  <div class="toast-container" id="toastContainer"></div>

  <!-- Load Socket.IO before our app script -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

  <!-- Application JS: single-file, no nested scripts -->
  <script>
    (function () {
      // ----- CONFIG -----
      const API_BASE = "https://uni-connect-tv-5.onrender.com"; // confirmed by you
      const STUN_SERVERS = [
        { urls: "stun:stun.l.google.com:19302" },
        { urls: "stun:stun1.l.google.com:19302" },
      ];

      // ----- STATE -----
      let socket = null;
      let pc = null; // RTCPeerConnection
      let localStream = null;
      let partnerId = null;
      let token = null;
      let isDemo = false;
      let isMuted = false;
      let isCameraOn = true;

      // ----- ELEMENTS -----
      const landing = document.getElementById("landing");
      const chatInterface = document.getElementById("chatInterface");
      const loginModal = document.getElementById("loginModal");
      const loginBtn = document.getElementById("loginBtn");
      const cancelBtn = document.getElementById("cancelBtn");
      const loginForm = document.getElementById("loginForm");
      const demoChatBtn = document.getElementById("demoChatBtn");
      const profileAvatar = document.getElementById("profileAvatar");
      const logoutBtn = document.getElementById("logoutBtn");
      const videoLocal = document.getElementById("videoLocal");
      const videoRemote = document.getElementById("videoRemote");
      const videoLocalBox = document.getElementById("videoLocalBox");
      const videoRemoteBox = document.getElementById("videoRemoteBox");
      const localStatus = document.getElementById("localStatus");
      const remoteStatus = document.getElementById("remoteStatus");
      const btnMute = document.getElementById("btnMute");
      const btnCamera = document.getElementById("btnCamera");
      const btnNext = document.getElementById("btnNext");
      const btnReport = document.getElementById("btnReport");
      const btnEnd = document.getElementById("btnEnd");
      const chatMessages = document.getElementById("chatMessages");
      const chatInput = document.getElementById("chatInput");
      const sendBtn = document.getElementById("sendBtn");
      const floatingToolbar = document.getElementById("floatingToolbar");
      const toastContainer = document.getElementById("toastContainer");
      const filterBtn = document.getElementById("filterBtn");
      const themeBtn = document.getElementById("themeBtn");
      const blurBtn = document.getElementById("blurBtn");

      // ----- HELPERS -----
      function showToast(msg, type = "info") {
        const d = document.createElement("div");
        d.className = "toast";
        d.textContent = msg;
        toastContainer.appendChild(d);
        setTimeout(() => d.remove(), 3500);
      }

      function resetChatUI() {
        // clear partner's video and chat
        chatMessages.innerHTML = "";
        const welcome = document.createElement("div");
        welcome.className = "message received";
        welcome.textContent = "Welcome to Uni-Connect TV! üëã";
        chatMessages.appendChild(welcome);
        videoRemote.style.display = "none";
        videoRemote.srcObject = null;
        videoRemoteBox.classList.remove("active");
        remoteStatus.classList.add("offline");
      }

      function addMessage(sender, text, isOwn = false) {
        const el = document.createElement("div");
        el.className = "message " + (isOwn ? "sent" : "received");
        el.textContent = (isOwn ? "You: " : sender + ": ") + text;
        chatMessages.appendChild(el);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      // ----- AUTH -----
      loginBtn.addEventListener("click", () => loginModal.classList.add("active"));
      cancelBtn.addEventListener("click", () => loginModal.classList.remove("active"));

      loginForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        const department = document.getElementById("department").value;
        try {
          const res = await fetch(`${API_BASE}/api/auth`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password, department }),
          });
          if (!res.ok) {
            const txt = await res.text();
            throw new Error(txt || "Auth failed");
          }
          const data = await res.json();
          token = data.token;
          localStorage.setItem("token", token);
          localStorage.setItem("email", data.email);
          profileAvatar.textContent = (data.email || "U").charAt(0).toUpperCase();
          loginModal.classList.remove("active");
          isDemo = false;
          showToast("Login successful", "success");
          await goToChat();
        } catch (err) {
          console.error("auth err", err);
          showToast("Login failed: " + (err.message || err), "danger");
        }
      });

      demoChatBtn.addEventListener("click", async () => {
        // demo user (no backend auth)
        isDemo = true;
        profileAvatar.textContent = "D";
        token = null;
        showToast("Demo mode: connecting (no saved data)", "info");
        await goToChat();
      });

      logoutBtn.addEventListener("click", () => {
        // stop media, disconnect socket
        stopLocalStream();
        if (socket) socket.disconnect();
        socket = null;
        token = null;
        isDemo = false;
        chatInterface.style.display = "none";
        landing.style.display = "flex";
        showToast("Logged out", "success");
      });

      // ----- NAVIGATION to CHAT -----
      async function goToChat() {
        landing.classList.add("hidden");
        setTimeout(() => {
          landing.style.display = "none";
          chatInterface.style.display = "flex";
          chatInterface.classList.add("active");
          floatingToolbar.style.display = "flex";
        }, 450);

        resetChatUI();
        // init socket & media
        await initLocalMedia();
        initSocket(); // sets up events and emits find-partner
      }

      // ----- MEDIA -----
      async function initLocalMedia() {
        try {
          localStream = await navigator.mediaDevices.getUserMedia({
            video: { width: { ideal: 1280 }, height: { ideal: 720 }, frameRate: { ideal: 30 } },
            audio: true,
          });
          videoLocal.srcObject = localStream;
          videoLocal.style.display = "block";
          document.querySelector("#videoLocalBox .video-placeholder").style.display = "none";
          localStatus.classList.remove("offline");
        } catch (err) {
          console.error("getUserMedia error", err);
          showToast("Allow camera & microphone", "warning");
        }
      }

      function stopLocalStream() {
        if (!localStream) return;
        localStream.getTracks().forEach((t) => t.stop());
        localStream = null;
        videoLocal.srcObject = null;
        videoLocal.style.display = "none";
        document.querySelector("#videoLocalBox .video-placeholder").style.display = "block";
        localStatus.classList.add("offline");
      }

      // ----- SOCKET.IO + SIGNALING -----
      function initSocket() {
        // prevent multiple initializations
        if (socket && socket.connected) {
          // already connected; ask for partner
          socket.emit("find-partner", { demo: isDemo });
          return;
        }

        // connect; include token if available
        const connectOpts = token ? { auth: { token } } : {};
        socket = io(API_BASE, connectOpts);

        socket.on("connect", () => {
          console.log("socket connected", socket.id);
          showToast("Socket connected", "success");
          // ask server to find partner
          socket.emit("find-partner", { demo: isDemo });
        });

        socket.on("waiting", () => {
          showToast("Waiting for partner...", "info");
        });

        socket.on("partner-found", async (id) => {
          // server gives partner socket id
          partnerId = id;
          showToast("Partner found ‚Äî establishing connection...", "success");
          // create PC and initiate offer
          await ensurePeerConnection();
          try {
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            socket.emit("signal", { to: partnerId, data: { type: "offer", offer: offer } });
          } catch (err) {
            console.error("offer error", err);
          }
        });

        socket.on("signal", async ({ from, data }) => {
          // incoming signaling data
          try {
            if (data.type === "offer") {
              partnerId = from;
              await ensurePeerConnection();
              await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
              const answer = await pc.createAnswer();
              await pc.setLocalDescription(answer);
              socket.emit("signal", { to: from, data: { type: "answer", answer } });
            } else if (data.type === "answer") {
              await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
            } else if (data.type === "candidate") {
              if (pc) await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
            }
          } catch (err) {
            console.error("signal handling error", err);
          }
        });

        socket.on("chatMessage", (payload) => {
          // payload can be either { sender, text } or simple string
          if (!payload) return;
          if (typeof payload === "string") {
            addMessage("Partner", payload, false);
            return;
          }
          if (payload.sender && payload.text) {
            addMessage(payload.sender, payload.text, false);
            return;
          }
          // fallback
          addMessage("Partner", JSON.stringify(payload), false);
        });

        socket.on("partner-left", () => {
          showToast("Partner disconnected", "warning");
          cleanupPeerConnection();
          // clear partner UI
          videoRemote.srcObject = null;
          videoRemote.style.display = "none";
          videoRemoteBox.classList.remove("active");
          remoteStatus.classList.add("offline");
        });

        socket.on("connect_error", (err) => {
          console.error("socket connect_error", err);
          showToast("Socket connect error", "danger");
        });
      }

      // ensure PC and handlers set once
      async function ensurePeerConnection() {
        if (pc) return pc;
        pc = new RTCPeerConnection({ iceServers: STUN_SERVERS });

        // add local tracks
        if (localStream) {
          localStream.getTracks().forEach((t) => pc.addTrack(t, localStream));
        }

        // remote track
        pc.ontrack = (ev) => {
          const [stream] = ev.streams;
          videoRemote.srcObject = stream;
          videoRemote.style.display = "block";
          document.querySelector("#videoRemoteBox .video-placeholder").style.display = "none";
          videoRemoteBox.classList.add("active");
          remoteStatus.classList.remove("offline");
        };

        // ice candidates
        pc.onicecandidate = (ev) => {
          if (ev.candidate && partnerId && socket) {
            socket.emit("signal", { to: partnerId, data: { type: "candidate", candidate: ev.candidate } });
          }
        };

        pc.onconnectionstatechange = () => {
          console.log("pc state", pc.connectionState);
          if (pc.connectionState === "failed" || pc.connectionState === "disconnected") {
            showToast("Connection problem ‚Äî trying to reconnect", "warning");
            // you can decide to re-find partner
          }
        };

        return pc;
      }

      function cleanupPeerConnection() {
        if (pc) {
          try { pc.close(); } catch (e) {}
          pc = null;
        }
        partnerId = null;
      }

      // ----- CONTROLS -----
      btnMute.addEventListener("click", () => {
        isMuted = !isMuted;
        if (localStream) {
          localStream.getAudioTracks().forEach((t) => (t.enabled = !isMuted));
        }
        btnMute.textContent = isMuted ? "üîá" : "üé§";
        showToast(isMuted ? "Muted" : "Unmuted", "info");
      });

      btnCamera.addEventListener("click", () => {
        isCameraOn = !isCameraOn;
        if (localStream) {
          localStream.getVideoTracks().forEach((t) => (t.enabled = isCameraOn));
        }
        btnCamera.textContent = isCameraOn ? "üé•" : "üì∑";
        showToast(isCameraOn ? "Camera On" : "Camera Off", "info");
      });

      btnNext.addEventListener("click", () => {
        showToast("Finding next partner...", "info");
        // stop current pc and ask server
        cleanupPeerConnection();
        socket?.emit("next-partner");
        resetChatUI();
      });

      btnReport.addEventListener("click", async () => {
        const ok = confirm("Report this user for inappropriate behavior?");
        if (!ok) return;
        try {
          const body = { reason: "Inappropriate behavior", reportedAt: new Date().toISOString() };
          // include token if available
          const res = await fetch(`${API_BASE}/api/report`, {
            method: "POST",
            headers: { "Content-Type": "application/json", ...(token ? { Authorization: `Bearer ${token}` } : {}) },
            body: JSON.stringify(body),
          });
          if (!res.ok) throw new Error(await res.text());
          showToast("User reported. Thank you.", "success");
        } catch (err) {
          console.error("report err", err);
          showToast("Report failed", "danger");
        }
      });

      btnEnd.addEventListener("click", () => {
        cleanupPeerConnection();
        socket?.emit("end-chat", { partnerId });
        // stop media but keep UI to landing
        stopLocalStream();
        chatInterface.style.display = "none";
        landing.style.display = "flex";
        showToast("Chat ended", "info");
      });

      // chat send
      sendBtn.addEventListener("click", sendChat);
      chatInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") sendChat();
      });

      function sendChat() {
        const txt = chatInput.value.trim();
        if (!txt) return;
        addMessage("You", txt, true);
        chatInput.value = "";
        // emit structured message
        if (socket && socket.connected) {
          socket.emit("chatMessage", { sender: localStorage.getItem("email") || (isDemo ? "Demo" : "You"), text: txt });
        } else {
          // if no socket, local echo only
          showToast("Not connected to server", "warning");
        }
      }

      // toolbar features (UI only)
      filterBtn.addEventListener("click", () => {
        const f = videoLocal.style.filter;
        if (!f) videoLocal.style.filter = "grayscale(0.5)";
        else if (f.includes("grayscale")) videoLocal.style.filter = "sepia(0.6)";
        else videoLocal.style.filter = "";
        showToast("Filter toggled", "info");
      });
      themeBtn.addEventListener("click", () => {
        const c = getComputedStyle(document.documentElement).getPropertyValue("--bg-dark").trim();
        if (c === "#0f0f10") document.documentElement.style.setProperty("--bg-dark", "#1a1a2e");
        else document.documentElement.style.setProperty("--bg-dark", "#0f0f10");
        showToast("Theme toggled", "info");
      });
      blurBtn.addEventListener("click", () => {
        const cur = videoLocal.style.backdropFilter;
        videoLocal.style.backdropFilter = cur ? "" : "blur(8px)";
        showToast("Local blur toggled", "info");
      });

      // init: restore token if present
      (function init() {
        const stored = localStorage.getItem("token");
        if (stored) token = stored;
        // optionally show landing
        landing.style.display = "flex";
      })();
    })();
  </script>
</body>
</html>
