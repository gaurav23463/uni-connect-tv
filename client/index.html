<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>UniConnect TV</title>
  <link rel="icon" href="/favicon.ico" />
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background-color: var(--bg, #111);
      color: var(--text, #fff);
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    [data-theme="light"] {
      --bg: #fff;
      --text: #111;
    }

    .theme-toggle {
      position: fixed;
      top: 10px;
      right: 20px;
      cursor: pointer;
      background: none;
      border: none;
      font-size: 18px;
      color: inherit;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: #222;
      padding: 20px;
      border-radius: 10px;
      width: 300px;
    }

    .chatInterface {
      display: none;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }

    .video-container {
      display: flex;
      gap: 20px;
    }

    .video-box {
      width: 320px;
      height: 240px;
      background: #333;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #999;
    }

    .controls {
      margin-top: 15px;
    }

    #chatMessages {
      height: 200px;
      overflow-y: auto;
      background: #222;
      padding: 10px;
      border-radius: 8px;
      width: 640px;
      margin-top: 15px;
    }

    .message {
      margin-bottom: 10px;
    }

    .message.own {
      text-align: right;
      color: #4caf50;
    }
  </style>
</head>

<body>
  <button class="theme-toggle" onclick="toggleTheme()">üåô Dark</button>

  <div id="landing">
    <h1>Welcome to UniConnect TV üé•</h1>
    <button onclick="showModal('auth')">Login / Signup</button>
    <button onclick="startDemo()">Start Demo</button>
  </div>

  <!-- LOGIN MODAL -->
  <div id="authModal" class="modal">
    <div class="modal-content">
      <h3>Login</h3>
      <form onsubmit="handleAuth(event)">
        <input id="email" type="email" placeholder="Email" required style="width:100%;margin-bottom:8px;" />
        <input id="password" type="password" placeholder="Password" required style="width:100%;margin-bottom:8px;" />
        <input id="department" type="text" placeholder="Department" required style="width:100%;margin-bottom:8px;" />
        <button type="submit" style="width:100%;">Login</button>
      </form>
      <button onclick="hideModal('auth')" style="margin-top:10px;">Close</button>
    </div>
  </div>

  <!-- CHAT INTERFACE -->
  <div id="chatInterface" class="chatInterface">
    <div class="video-container">
      <div class="video-box" id="localVideoBox">üé• You</div>
      <div class="video-box" id="remoteVideoBox">üîç Waiting...</div>
    </div>

    <div class="controls">
      <button onclick="nextPartner()">Next</button>
      <button onclick="reportUser()">Report</button>
      <button onclick="endChat()">End Chat</button>
    </div>

    <div id="chatMessages"></div>
    <textarea id="chatInput" placeholder="Type message..." rows="2" style="width:640px;" onkeydown="handleChatInput(event)"></textarea>
  </div>

  <!-- === TOP SCRIPT: UI + AUTH === -->
  <script>
    // THEME TOGGLE
    function toggleTheme() {
      const body = document.body;
      const btn = document.querySelector('.theme-toggle');
      if (body.getAttribute('data-theme') === 'light') {
        body.removeAttribute('data-theme');
        btn.innerHTML = 'üåô Dark';
      } else {
        body.setAttribute('data-theme', 'light');
        btn.innerHTML = '‚òÄÔ∏è Light';
      }
    }

    // MODALS
    function showModal(type) {
      document.getElementById(type + 'Modal').classList.add('active');
    }
    function hideModal(type) {
      document.getElementById(type + 'Modal').classList.remove('active');
    }

    // AUTH HANDLER
    async function handleAuth(e) {
      e.preventDefault();
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      const department = document.getElementById("department").value;

      const API_BASE =
        window.location.hostname.includes("localhost")
          ? "http://localhost:5000"
          : "https://uni-connect-tv-5.onrender.com";

      try {
        const res = await fetch(`${API_BASE}/api/auth`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password, department }),
        });

        if (!res.ok) throw new Error(await res.text());
        const data = await res.json();
        localStorage.setItem("token", data.token);
        localStorage.setItem("email", data.email);
        hideModal("auth");
        startChat();
        showNotification(`Welcome ${data.email}!`, "success");
      } catch (err) {
        showNotification("Login failed: " + err.message, "danger");
      }
    }

    // DEMO
    function startDemo() {
      startChat();
      showNotification("Demo Mode Activated!", "info");
    }

    // NOTIFICATIONS
    function showNotification(msg, type = "info") {
      const note = document.createElement("div");
      note.style.cssText = `
        position:fixed;top:20px;right:20px;
        background:#333;color:white;padding:10px 15px;
        border-radius:6px;z-index:2000;
      `;
      note.textContent = msg;
      document.body.appendChild(note);
      setTimeout(() => note.remove(), 3000);
    }

    // MODAL CLICK CLOSE
    window.onclick = (e) => {
      document.querySelectorAll('.modal').forEach(modal => {
        if (e.target === modal) modal.classList.remove('active');
      });
    };
  </script>

  <!-- === SOCKET.IO & VIDEO LOGIC === -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script>
    const socket = io("https://uni-connect-tv-5.onrender.com");
    let localStream, peerConnection, partnerId;
    const servers = {
      iceServers: [
        { urls: "stun:stun.l.google.com:19302" },
        { urls: "stun:stun1.l.google.com:19302" },
      ],
    };

    // START CHAT
    async function startChat() {
      document.getElementById("landing").style.display = "none";
      document.getElementById("chatInterface").style.display = "flex";
      await initCamera();
      socket.emit("find-partner");
      showNotification("üîç Searching for partner...");
    }

    socket.on("waiting", () => showNotification("Waiting for a user..."));
    socket.on("partner-found", async (id) => {
      partnerId = id;
      showNotification("üéâ Partner found! Connecting...");
      await createPeerConnection();
      const offer = await peerConnection.createOffer();
      await peerConnection.setLocalDescription(offer);
      socket.emit("signal", { to: partnerId, data: { type: "offer", offer } });
    });

    socket.on("signal", async ({ from, data }) => {
      partnerId = from;
      if (data.type === "offer") {
        await createPeerConnection();
        await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);
        socket.emit("signal", { to: from, data: { type: "answer", answer } });
      } else if (data.type === "answer") {
        await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
      } else if (data.type === "candidate" && peerConnection) {
        await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
      }
    });

    socket.on("partner-left", () => {
      showNotification("‚ùå Partner disconnected", "danger");
      if (peerConnection) peerConnection.close();
      peerConnection = null;
      document.getElementById("remoteVideoBox").innerHTML = "üîç Waiting...";
    });

    async function initCamera() {
      try {
        localStream = await navigator.mediaDevices.getUserMedia({
          video: { width: 640, height: 480 },
          audio: true,
        });
        const box = document.getElementById("localVideoBox");
        box.innerHTML = "";
        const video = document.createElement("video");
        video.srcObject = localStream;
        video.autoplay = true;
        video.muted = true;
        box.appendChild(video);
      } catch (e) {
        showNotification("Camera/mic access denied.", "danger");
      }
    }

    async function createPeerConnection() {
      peerConnection = new RTCPeerConnection(servers);
      localStream.getTracks().forEach((t) => peerConnection.addTrack(t, localStream));

      peerConnection.ontrack = (e) => {
        const [stream] = e.streams;
        const box = document.getElementById("remoteVideoBox");
        box.innerHTML = "";
        const video = document.createElement("video");
        video.srcObject = stream;
        video.autoplay = true;
        box.appendChild(video);
      };

      peerConnection.onicecandidate = (e) => {
        if (e.candidate && partnerId)
          socket.emit("signal", { to: partnerId, data: { type: "candidate", candidate: e.candidate } });
      };
    }

    function nextPartner() {
      if (peerConnection) peerConnection.close();
      socket.emit("find-partner");
      document.getElementById("remoteVideoBox").innerHTML = "üîç Searching...";
    }

    function reportUser() {
      showNotification("User reported.", "warning");
    }

    function endChat() {
      if (peerConnection) peerConnection.close();
      document.getElementById("chatInterface").style.display = "none";
      document.getElementById("landing").style.display = "block";
      showNotification("Chat ended.", "info");
    }

    // CHAT
    function handleChatInput(e) {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        const input = e.target;
        const message = input.value.trim();
        if (message) {
          addMessage("You", message, true);
          input.value = "";
          socket.emit("chatMessage", { message });
        }
      }
    }

    socket.on("chatMessage", (msg) => {
      addMessage("Partner", msg.message, false);
    });

    function addMessage(sender, text, own) {
      const div = document.createElement("div");
      div.className = `message ${own ? "own" : ""}`;
      div.textContent = `${sender}: ${text}`;
      document.getElementById("chatMessages").appendChild(div);
    }
  </script>
</body>
</html>
